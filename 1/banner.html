<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HomDGCat – Gacha Banners (Tailwind)</title>
  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* fallback skeleton shimmer */
    .shimmer { background: linear-gradient(90deg,#f3f4f6 25%,#e5e7eb 37%,#f3f4f6 63%); background-size: 400% 100%; animation: shimmer 1.4s ease infinite; }
    @keyframes shimmer { 0%{background-position:100% 0} 100%{background-position:-100% 0} }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <header class="sticky top-0 z-10 bg-white/80 backdrop-blur border-b border-slate-200">
    <div class="max-w-6xl mx-auto px-4 py-4 flex flex-col sm:flex-row items-start sm:items-center gap-3">
      <h1 class="text-2xl font-bold">HomDGCat – Gacha Banners</h1>
      <div class="ml-auto flex flex-wrap items-center gap-2">
        <label class="text-sm font-medium">Lang</label>
        <select id="lang" class="px-3 py-1.5 rounded-lg border border-slate-300 bg-white">
          <option>EN</option>
          <option>JP</option>
          <option>CH</option>
          <option>KR</option>
          <option>RU</option>
        </select>
        <button id="reload" class="px-3 py-1.5 rounded-lg bg-slate-900 text-white hover:bg-slate-800">Reload</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 pb-24">
    <section class="my-6 grid gap-3 sm:grid-cols-3 items-center">
      <div class="col-span-2 flex items-center gap-2">
        <input id="search" type="text" placeholder="Filter by character name…" class="w-full px-3 py-2 rounded-xl border border-slate-300 focus:outline-none focus:ring-2 focus:ring-slate-400" />
        <button id="reset" class="px-3 py-2 rounded-xl border border-slate-300 hover:bg-slate-100">Reset</button>
      </div>
      <div class="text-right text-sm text-slate-600" id="meta"></div>
    </section>

    <div id="container" class="grid gap-6"></div>

    <template id="skeleton">
      <div class="rounded-2xl border border-slate-200 bg-white p-4">
        <div class="h-6 w-32 shimmer rounded"></div>
        <div class="grid sm:grid-cols-2 gap-4 mt-4">
          <div class="rounded-xl border border-slate-200 p-3"><div class="h-5 w-24 shimmer rounded"></div><div class="grid grid-cols-6 gap-2 mt-3">${"<div class='aspect-square rounded-lg shimmer'></div>".repeat(6)}</div></div>
          <div class="rounded-xl border border-slate-200 p-3"><div class="h-5 w-24 shimmer rounded"></div><div class="grid grid-cols-6 gap-2 mt-3">${"<div class='aspect-square rounded-lg shimmer'></div>".repeat(6)}</div></div>
        </div>
      </div>
    </template>
  </main>

  <footer class="border-t border-slate-200 bg-white">
    <div class="max-w-6xl mx-auto px-4 py-6 text-xs text-slate-500">
      Icons © HomDGCat • Data scraped from <code>/gi/banner.js</code>. This page is a community viewer.
    </div>
  </footer>

  <script>
    const API_BASE = 'https://banner-liart.vercel.app'; // your deployed endpoint (from your message)
    const ICON_BASE = 'https://homdgcat.wiki/homdgcat-res/Avatar/';

    const $c = (sel, el=document) => el.querySelector(sel);
    const $$c = (sel, el=document) => [...el.querySelectorAll(sel)];

    const container = $c('#container');
    const meta = $c('#meta');

    function skeleton(n=3){
      container.innerHTML = '';
      const tpl = $c('#skeleton');
      for(let i=0;i<n;i++) container.appendChild(tpl.content.cloneNode(true));
    }

    function nameToIcon(name){
      // Most names map directly: UI_AvatarIcon_<Name>.png
      // Handle a few known aliases from HomDGCat
      const aliases = {
        Qin: 'Jean', Baizhuer: 'Baizhu', Liney: 'Liney', Linette: 'Lynette',
        Momoka: 'Kirara', Shougun: 'Raiden_Shogun', Feiyan: 'Yanfei', Noel: 'Noelle'
      };
      const safe = (aliases[name] || name)
        .replace(/\s+/g, '_')
        .replace(/[^A-Za-z0-9_]/g,'');
      return `${ICON_BASE}UI_AvatarIcon_${safe}.png`;
    }

    function chip(name, star){
      const url = nameToIcon(name);
      const title = name;
      return `
        <div class="flex items-center gap-2 p-2 rounded-xl border border-slate-200 bg-slate-50">
          <img src="${url}" alt="${title}" onerror="this.style.display='none'" class="w-8 h-8 rounded-lg"/>
          <span class="text-sm ${star===5?'font-semibold':''}">${title}</span>
        </div>`;
    }

    function render(data){
      meta.textContent = `Lang: ${data.lang} • Versions: ${data.versions.length} • Scraped: ${new Date(data.scrapedAt).toLocaleString()}`;
      container.innerHTML = '';

      const q = $c('#search').value.trim().toLowerCase();

      data.versions.forEach(v => {
        // filter by search term (any phase having that character)
        const match = (arr=[]) => arr.some(n => n.toLowerCase().includes(q));
        const phases = v.phases.map(p => {
          const banners = p.banners.map(b => ({
            title: b.title,
            five: b.fiveStar || [],
            four: b.fourStar || []
          })).filter(b => !q || match(b.five) || match(b.four));
          return {...p, _banners: banners};
        }).filter(p => p._banners.length);

        if (!phases.length) return; // skip version not matching filter

        const versionCard = document.createElement('div');
        versionCard.className = 'rounded-2xl border border-slate-200 bg-white p-5 shadow-sm';
        versionCard.innerHTML = `
          <div class="flex items-center justify-between gap-3">
            <h2 class="text-xl font-bold">Version ${v.version}</h2>
          </div>
          <div class="grid sm:grid-cols-2 gap-4 mt-4"></div>
        `;
        const grid = $c('div.grid', versionCard);

        phases.forEach(p => {
          const card = document.createElement('div');
          card.className = 'rounded-xl border border-slate-200 p-4';
          const banner = p._banners[0]; // one logical banner per phase in our API
          const five = (banner.five || []).map(n => chip(n,5)).join('');
          const four = (banner.four || []).map(n => chip(n,4)).join('');

          card.innerHTML = `
            <div class="flex items-center justify-between">
              <h3 class="font-semibold">${p.phase}</h3>
            </div>
            <div class="mt-3">
              <div class="text-xs uppercase tracking-wide text-slate-500 mb-1">5★ Characters</div>
              <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">${five || '<div class=\'text-sm text-slate-400\'>None</div>'}</div>
            </div>
            <div class="mt-4">
              <div class="text-xs uppercase tracking-wide text-slate-500 mb-1">4★ Characters</div>
              <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">${four || '<div class=\'text-sm text-slate-400\'>None</div>'}</div>
            </div>
          `;
          grid.appendChild(card);
        });

        container.appendChild(versionCard);
      });

      if (!container.children.length){
        container.innerHTML = '<div class="p-6 text-center text-slate-500">No results. Try another character or clear the search.</div>'
      }
    }

    async function load(){
      skeleton();
      const lang = $c('#lang').value || 'EN';
      const url = `${API_BASE}?lang=${encodeURIComponent(lang)}&ts=${Date.now()}`;
      try{
        const r = await fetch(url);
        const j = await r.json();
        window.__DATA__ = j;
        render(j);
      }catch(e){
        container.innerHTML = `<div class="p-6 text-center text-red-600">Failed to load data: ${String(e)}</div>`;
      }
    }

    // events
    $c('#reload').addEventListener('click', load);
    $c('#lang').addEventListener('change', load);
    $c('#reset').addEventListener('click', () => { $c('#search').value = ''; render(window.__DATA__ || {versions:[]}); });
    $c('#search').addEventListener('input', () => render(window.__DATA__ || {versions:[]}));

    // initial
    load();
  </script>
</body>
</html>
