<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Komentar + Reply + Upload + Emoji + Pin/Hapus</title>
<style>
  /* ====== VARIABEL WARNA ====== */
  :root {
    --bg: #0a0a0f;
    --panel: #101018;
    --line: #232545;
    --txt: #eef1ff;
    --muted: #9aa4bf;
    --pri: #7c4dff;
    --pri2: #8b5dff;
    --accent: #ff6b6b;
    --success: #51cf66;
    --warning: #ffd43b;
    --info: #339af0;
    --popular: #ff9f43;
    --gradient-1: linear-gradient(135deg, var(--pri), var(--pri2));
    --gradient-2: linear-gradient(135deg, #667eea, #764ba2);
    --gradient-3: linear-gradient(135deg, #f093fb, #f5576c);
    --gradient-popular: linear-gradient(135deg, #ff9f43, #feca57);
    --shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* ====== RESET & BASE ====== */
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    margin: 0;
    background: var(--bg);
    color: var(--txt);
    font-family: Inter, system-ui, Segoe UI, Roboto, Arial, sans-serif;
    line-height: 1.6;
    overflow-x: hidden;
  }

  /* ====== LAYOUT ====== */
  main {
    max-width: 860px;
    margin: 28px auto;
    padding: 0 14px;
  }

  .panel {
    background: var(--panel);
    border: 1px solid var(--line);
    border-radius: 16px;
    padding: 20px;
    box-shadow: var(--shadow);
    transition: var(--transition);
  }

  .panel:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
  }

  /* ====== FORM ELEMENTS ====== */
  label {
    display: block;
    font-size: 14px;
    font-weight: 700;
    color: #cfd6ff;
    margin-bottom: 8px;
  }

  input, textarea, button, select {
    width: 100%;
    padding: 12px 14px;
    border-radius: 12px;
    border: 1px solid #2a2e63;
    background: #0d0f2c;
    color: var(--txt);
    font-size: 14px;
    transition: var(--transition);
  }

  input:focus, textarea:focus, select:focus {
    outline: none;
    border-color: var(--pri);
    box-shadow: 0 0 0 3px rgba(124, 77, 255, 0.2);
  }

  textarea {
    min-height: 110px;
    resize: vertical;
  }

  select {
    cursor: pointer;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%239aa4bf' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    padding-right: 36px;
    appearance: none;
  }

  /* ====== BUTTONS ====== */
  button {
    cursor: pointer;
    background: var(--gradient-1);
    border: none;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    position: relative;
    overflow: hidden;
  }

  button:before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.2);
    transition: left 0.5s;
  }

  button:hover:before {
    left: 100%;
  }

  button.alt {
    background: #20255a;
    border: 1px solid #313b7a;
  }

  button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(124, 77, 255, 0.3);
  }

  /* ====== LAYOUT UTILITIES ====== */
  .row {
    display: grid;
    gap: 16px;
  }

  .grid2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }

  .flex {
    display: flex;
  }

  .flex-center {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .flex-between {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  /* ====== TOOLBAR ====== */
  .toolbar {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    align-items: center;
    position: relative;
    margin: 16px 0;
  }

  .tool {
    padding: 10px 14px;
    border: 1px solid #2a2e63;
    border-radius: 999px;
    background: #0f1130;
    cursor: pointer;
    transition: var(--transition);
    font-size: 14px;
  }

  .tool:hover {
    background: #1a1f4a;
    transform: translateY(-2px);
  }

  .status {
    font-size: 13px;
    margin-top: 8px;
    padding: 8px 12px;
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.05);
  }

  .status.ok {
    background: rgba(81, 207, 102, 0.2);
    color: var(--success);
  }

  .status.err {
    background: rgba(255, 107, 107, 0.2);
    color: var(--accent);
  }

  .status.warn {
    background: rgba(255, 212, 59, 0.2);
    color: var(--warning);
  }

  /* ====== CHIPS ====== */
  .chips {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 16px;
  }

  .chip {
    border: 1px solid #2a2e63;
    background: #0f1130;
    padding: 8px 12px;
    border-radius: 999px;
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  /* ====== COMMENT LIST ====== */
  .list {
    display: grid;
    gap: 16px;
    margin-top: 16px;
  }

  .item {
    background: #14162a;
    border: 1px solid #2a2e63;
    border-radius: 12px;
    padding: 16px;
    transition: var(--transition);
    position: relative;
    overflow: hidden;
  }

  .item:before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: var(--gradient-1);
    opacity: 0;
    transition: var(--transition);
  }

  .item.popular {
    border-color: var(--popular);
    background: linear-gradient(135deg, rgba(255, 159, 67, 0.1), rgba(254, 202, 87, 0.05));
  }

  .item.popular:before {
    background: var(--gradient-popular);
    opacity: 1;
  }

  .item:hover:before {
    opacity: 1;
  }

  .item:hover {
    transform: translateX(4px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  }

  /* ====== POPULAR BADGE ====== */
  .popular-badge {
    position: absolute;
    top: 10px;
    right: 10px;
    background: var(--gradient-popular);
    color: white;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 4px;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }

  .score-display {
    position: absolute;
    top: 10px;
    left: 10px;
    background: rgba(0, 0, 0, 0.7);
    color: var(--popular);
    padding: 4px 8px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 700;
    display: none;
  }

  .sort-popular .score-display {
    display: block;
  }

  /* ====== COMMENT HEADER ====== */
  .head {
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
  }

  .name {
    font-weight: 900;
    font-size: 16px;
  }

  .badge {
    font-size: 11px;
    border: 1px solid #3a3f86;
    background: #121540;
    color: #cfe1ff;
    padding: 3px 8px;
    border-radius: 999px;
  }

  .badge.admin {
    border-color: #8aa0ff;
    background: var(--gradient-2);
    color: white;
  }

  .time {
    color: var(--muted);
    font-size: 12px;
    margin-left: auto;
  }

  /* ====== COMMENT BODY ====== */
  .replyto {
    display: inline-block;
    margin-top: 8px;
    font-size: 12px;
    color: #cfe1ff;
    border: 1px solid #2a2e63;
    background: #0f1130;
    padding: 4px 10px;
    border-radius: 999px;
  }

  .body {
    white-space: pre-wrap;
    margin-top: 12px;
    line-height: 1.6;
  }

  .imgwrap {
    margin-top: 12px;
    border-radius: 10px;
    overflow: hidden;
  }

  .imgwrap img {
    max-width: 100%;
    border-radius: 10px;
    border: 1px solid #2a2e63;
    transition: var(--transition);
  }

  .imgwrap img:hover {
    transform: scale(1.02);
  }

  /* ====== ACTIONS ====== */
  .actions {
    display: flex;
    gap: 8px;
    align-items: center;
    margin-top: 12px;
    color: #cbd5ff;
    flex-wrap: wrap;
  }

  .action {
    display: inline-flex;
    gap: 6px;
    align-items: center;
    padding: 6px 12px;
    border: 1px solid #29306c;
    border-radius: 999px;
    background: #0d1133;
    cursor: pointer;
    font-size: 13px;
    transition: var(--transition);
  }

  .action:hover {
    background: #1a1f4a;
    transform: translateY(-2px);
  }

  .admin-actions {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
  }

  /* ====== REACTIONS ====== */
  .reactions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-top: 12px;
  }

  .reaction {
    display: inline-flex;
    gap: 6px;
    align-items: center;
    padding: 6px 12px;
    border: 1px solid #2b3c76;
    border-radius: 999px;
    background: #0a1333;
    cursor: pointer;
    font-size: 13px;
    transition: var(--transition);
  }

  .reaction:hover {
    background: #1a1f4a;
    transform: translateY(-2px);
  }

  .reaction img {
    width: 18px;
    height: 18px;
  }

  /* ====== REPLIES ====== */
  .children {
    margin-left: 24px;
    border-left: 2px dashed #2a2e63;
    padding-left: 16px;
    display: grid;
    gap: 12px;
    margin-top: 16px;
    transition: var(--transition);
  }

  .replybox {
    margin-top: 16px;
    border: 1px dashed #394182;
    border-radius: 12px;
    padding: 16px;
    background: rgba(15, 17, 48, 0.5);
  }

  /* ====== TOGGLE REPLIES ====== */
  .child-toggle {
    margin-top: 12px;
  }

  .toggle-replies {
    background: #1a1c3a;
    border: 1px solid #333a7a;
    color: #cbd5ff;
    padding: 6px 12px;
    border-radius: 999px;
    font-size: 13px;
    cursor: pointer;
    margin-top: 8px;
    width: auto;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    transition: var(--transition);
  }

  .toggle-replies:hover {
    background: #232861;
    transform: translateY(-2px);
  }

  .hidden {
    display: none;
  }

  /* ====== EMOJI PICKER ====== */
  #emojiPicker {
    display: none;
    position: absolute;
    top: 46px;
    left: 0;
    background: #0e1030;
    border: 1px solid #2a2e63;
    border-radius: 12px;
    padding: 12px;
    grid-template-columns: repeat(8, 34px);
    gap: 6px;
    z-index: 50;
    box-shadow: var(--shadow);
  }

  #emojiPicker button {
    padding: 6px;
    border-radius: 8px;
    border: 1px solid #2a2e63;
    background: #151848;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: var(--transition);
  }

  #emojiPicker button:hover {
    background: #1a1f4a;
    transform: scale(1.1);
  }

  #emojiPicker img {
    width: 22px;
    height: 22px;
  }

  .emojiimg {
    width: 22px;
    height: 22px;
    vertical-align: middle;
    border-radius: 4px;
  }

  /* ====== PINNED SECTION ====== */
  .pinned {
    border: 1px dashed #5b63c0;
    padding: 16px;
    border-radius: 12px;
    background: linear-gradient(135deg, rgba(18, 22, 64, 0.8), rgba(26, 36, 90, 0.8));
    margin-bottom: 16px;
    position: relative;
  }

  .pinned:before {
    content: 'üìå';
    position: absolute;
    top: -10px;
    left: 16px;
    background: var(--bg);
    padding: 0 8px;
    font-size: 18px;
  }

  .pinlabel {
    font-size: 13px;
    color: #bfc9ff;
    margin-bottom: 8px;
    display: flex;
    gap: 6px;
    align-items: center;
  }

  /* ====== SORT OPTIONS ====== */
  .sort-container {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .sort-btn {
    padding: 6px 12px;
    border-radius: 8px;
    background: #0f1130;
    border: 1px solid #2a2e63;
    color: var(--muted);
    font-size: 13px;
    cursor: pointer;
    transition: var(--transition);
    position: relative;
  }

  .sort-btn.active {
    background: var(--gradient-1);
    color: white;
    border-color: var(--pri);
  }

  .sort-btn.popular.active {
    background: var(--gradient-popular);
    border-color: var(--popular);
  }

  .sort-btn:hover:not(.active) {
    background: #1a1f4a;
    color: var(--txt);
  }

  .sort-btn .sort-icon {
    margin-right: 4px;
  }

  /* ====== RESPONSIVE DESIGN ====== */
  @media (max-width: 768px) {
    main {
      margin: 16px auto;
      padding: 0 12px;
    }

    .panel {
      padding: 16px;
    }

    .grid2 {
      grid-template-columns: 1fr;
    }

    .toolbar {
      gap: 8px;
    }

    .tool {
      padding: 8px 12px;
      font-size: 13px;
    }

    .head {
      flex-direction: column;
      align-items: flex-start;
    }

    .time {
      margin-left: 0;
      margin-top: 4px;
    }

    .actions {
      gap: 6px;
    }

    .action {
      padding: 5px 10px;
      font-size: 12px;
    }

    .children {
      margin-left: 16px;
      padding-left: 12px;
    }

    #emojiPicker {
      grid-template-columns: repeat(6, 34px);
    }

    .popular-badge {
      font-size: 10px;
      padding: 3px 8px;
    }
  }

  @media (max-width: 480px) {
    .panel {
      padding: 12px;
    }

    .chips {
      flex-direction: column;
      align-items: flex-start;
    }

    .chip {
      width: 100%;
      justify-content: center;
    }

    #emojiPicker {
      grid-template-columns: repeat(5, 34px);
      left: -20px;
      right: -20px;
      width: auto;
    }

    .sort-container {
      flex-wrap: wrap;
    }
  }

  /* ====== ANIMATIONS ====== */
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .item {
    animation: fadeIn 0.3s ease-out;
  }

  /* ====== LOADING SPINNER ====== */
  .spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: var(--pri);
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* ====== EMPTY STATE ====== */
  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--muted);
  }

  .empty-state-icon {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.5;
  }

  .empty-state-text {
    font-size: 16px;
    margin-bottom: 8px;
  }

  .empty-state-subtext {
    font-size: 14px;
    opacity: 0.7;
  }

  /* ====== SORT HEADER ====== */
  .sort-header {
    padding: 8px 16px;
    margin-bottom: 16px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    font-weight: 600;
  }

  .sort-header.popular {
    background: linear-gradient(135deg, rgba(255, 159, 67, 0.2), rgba(254, 202, 87, 0.1));
    border: 1px solid var(--popular);
    color: var(--popular);
  }

  .sort-header.new {
    background: linear-gradient(135deg, rgba(124, 77, 255, 0.2), rgba(139, 93, 255, 0.1));
    border: 1px solid var(--pri);
    color: var(--pri);
  }

  .sort-header.old {
    background: linear-gradient(135deg, rgba(52, 211, 153, 0.2), rgba(16, 185, 129, 0.1));
    border: 1px solid #34d399;
    color: #34d399;
  }

  /* ====== OFFLINE INDICATOR ====== */
  .offline-indicator {
    position: fixed;
    top: 10px;
    right: 10px;
    background: var(--warning);
    color: var(--bg);
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 600;
    z-index: 100;
    animation: slideIn 0.3s ease-out;
  }

  @keyframes slideIn {
    from { transform: translateX(100%); }
    to { transform: translateX(0); }
  }
</style>
</head>
<body>
<main>
  <section class="panel row" id="rootForm">
    <div>
      <label>Nama</label>
      <input id="name" placeholder="Nama kamu" maxlength="60">
    </div>
    <div>
      <label>Komen di mari‚Ä¶</label>
      <textarea id="message" placeholder="Tulis komentar (Shift+Enter = baris baru)" maxlength="2000"></textarea>
    </div>

    <div class="toolbar">
      <span class="tool" id="emojiBtn">üòÄ Emoji</span>
      <span class="tool" id="imageUrlBtn">üñºÔ∏è URL</span>
      <span class="tool" id="uploadBtn">‚¨ÜÔ∏è Upload</span>
      <span class="tool" id="adminBtn">Badge: <b id="badgeLabel">visitor</b></span>
      <span class="tool" id="adminLogoutBtn" style="display:none">Logout Admin</span>
      <input type="text" id="imageUrlInput" placeholder="https://‚Ä¶" style="display:none;min-width:260px">
      <input type="file" id="fileInput" accept="image/*" style="display:none">
      <div id="emojiPicker"></div>
    </div>

    <div class="grid2">
      <button id="send">Kirim</button>
      <button id="reload" class="alt" type="button">Muat Ulang</button>
    </div>
    <div id="status" class="status"></div>
  </section>

  <div style="height:20px"></div>

  <section class="panel">
    <div class="chips">
      <span class="chip"><b id="countComments">0</b> Komentar</span>
      <div class="sort-container">
        <span>Sort:</span>
        <button class="sort-btn active" data-sort="new">
          <span class="sort-icon">üïê</span>Terbaru
        </button>
        <button class="sort-btn" data-sort="old">
          <span class="sort-icon">üìÖ</span>Terlama
        </button>
        <button class="sort-btn popular" data-sort="top">
          <span class="sort-icon">üî•</span>Terpopuler
        </button>
      </div>
    </div>

    <div id="sortHeader" class="sort-header" style="display:none"></div>

    <div id="pinnedWrap" style="display:none" class="pinned">
      <div class="pinlabel">Komentar disematkan</div>
      <div id="pinnedBox"></div>
    </div>

    <div class="list" id="list">
      <div class="empty-state">
        <div class="empty-state-icon">üí¨</div>
        <div class="empty-state-text">Belum ada komentar</div>
        <div class="empty-state-subtext">Jadilah yang pertama berkomentar!</div>
      </div>
    </div>
  </section>
</main>

<script>
(function(){
  /* ====== CONFIG ====== */
  const API_BASE = 'https://telestick.vercel.app/api';
  const EP = {
    GET:   s => `${API_BASE}/comments-get?slug=${encodeURIComponent(s)}`,
    POST:  `${API_BASE}/comments-post`,
    LIKE:  `${API_BASE}/comments-like`,
    REACT: `${API_BASE}/comments-react`,
    UPLOAD:`${API_BASE}/comments-upload`,
    EMOJI: `${API_BASE}/emoji-list`,
    PIN:   `${API_BASE}/comments-pin`,
    DEL:   `${API_BASE}/comments-delete`
  };
  const COMMENT_REACTIONS = [
    { key:'heart', label:'Love', icon:'https://raw.githubusercontent.com/twitter/twemoji/master/assets/svg/2764.svg' },
    { key:'joy',   label:'Haha', icon:'https://raw.githubusercontent.com/twitter/twemoji/master/assets/svg/1f602.svg' },
    { key:'wow',   label:'Wow',  icon:'https://raw.githubusercontent.com/twitter/twemoji/master/assets/svg/1f62e.svg' }
  ];
  const ADMIN_BADGE='katheryne';
  const SLUG = (new URL(location.href)).searchParams.get('slug') || location.pathname || '/';

  /* ====== PATCH: util merge dan cache ====== */
  function arrToMap(arr){ 
    const m=new Map(); 
    for(const x of arr||[]) m.set(String(x.id), x); 
    return m; 
  }
  
  function mergeById(oldArr, newArr){
    const m = arrToMap(oldArr);
    for(const it of (newArr||[])) m.set(String(it.id), it);
    return Array.from(m.values());
  }
  
  const CACHE_KEY = 'kathy_comments_cache:' + (location.pathname || '/');

  /* ====== ELEMENTS ====== */
  const $=s=>document.querySelector(s);
  const E={
    name:$('#name'), msg:$('#message'),
    emojiBtn:$('#emojiBtn'), emojiPicker:$('#emojiPicker'),
    imageUrlBtn:$('#imageUrlBtn'), imageUrlInput:$('#imageUrlInput'),
    uploadBtn:$('#uploadBtn'), fileInput:$('#fileInput'),
    adminBtn:$('#adminBtn'), badgeLabel:$('#badgeLabel'),
    adminLogoutBtn:$('#adminLogoutBtn'),
    send:$('#send'), reload:$('#reload'), status:$('#status'),
    list:$('#list'), count:$('#countComments'),
    pinnedWrap:$('#pinnedWrap'), pinnedBox:$('#pinnedBox'),
    sortHeader:$('#sortHeader')
  };

  /* ====== STATE ====== */
  let ADMIN_OK = false;
  const storedKey = localStorage.getItem('kathy_admin_key') || '';
  let data=[]; 
  let EMOJI_ITEMS=[], EMOJI_MAP=new Map(); 
  let activeTextArea = E.msg;
  let PIN_ID = null;
  let currentSort = 'new';

  /* ====== ADMIN VERIFICATION ====== */
  async function verifyAdmin(key) {
    try {
      const r = await fetch(`${API_BASE}/admin-verify`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ key })
      });
      ADMIN_OK = r.ok;
      if (ADMIN_OK) {
        localStorage.setItem('kathy_admin_key', key);
        E.badgeLabel.textContent = 'katheryne';
        E.adminLogoutBtn.style.display = 'inline-block';
        setStatus('üîë Admin on','ok');
      } else {
        localStorage.removeItem('kathy_admin_key');
        E.badgeLabel.textContent = 'visitor';
        E.adminLogoutBtn.style.display = 'none';
        setStatus('Admin off','warn');
      }
    } catch {
      ADMIN_OK = false;
      E.badgeLabel.textContent = 'visitor';
      E.adminLogoutBtn.style.display = 'none';
    }
  }

  const isAdmin = () => ADMIN_OK;

  function adminHeader() {
    const k = localStorage.getItem('kathy_admin_key') || '';
    return k ? { 'x-admin-key': k } : {};
  }

  // inisialisasi awal
  verifyAdmin(storedKey);

  /* ====== UTILS ====== */
  const esc = s=>(s??'').toString().replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
  const time = s=>{ const d=new Date(s); return isNaN(d)?s:d.toLocaleString(); };
  const setStatus=(m,t='')=>{ E.status.textContent=m||''; E.status.className='status '+t; };
  const sum = a=>a.reduce((x,y)=>x+Number(y||0),0);
  const score = it => Number(it.likes||0)+sum(Object.values(it.reactions||{}));
  const safeJson=async(res)=>{ 
    const ct=res.headers.get('content-type')||''; 
    if(!ct.includes('application/json')){ 
      const text=await res.text(); 
      throw new Error(`Bukan JSON (status ${res.status}): ${text.slice(0,140)}‚Ä¶`); 
    } 
    return res.json(); 
  };

  /* ====== API ====== */
  async function apiPost(p){ 
    try {
      setStatus('<span class="spinner"></span> Mengirim komentar...');
      const r=await fetch(EP.POST,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(p)}); 
      const j=await safeJson(r); 
      if(!j.ok) throw new Error(j.error||`HTTP ${r.status}`); 
      return j.item; 
    } catch (error) {
      setStatus('‚ùå '+(error.message||error),'err');
      throw error;
    }
  }
  
  async function apiLike(id,delta=1){ 
    try{ 
      const r=await fetch(EP.LIKE,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id,slug:SLUG,delta})}); 
      if(r.status===404) throw new Error('no-like'); 
      const j=await safeJson(r); 
      if(!j.ok) throw new Error(j.error); 
      return j; 
    }catch{ 
      const k='k_like_'+id, v=Number(localStorage.getItem(k)||0)+Number(delta||1); 
      localStorage.setItem(k,Math.max(0,v)); 
      return {ok:true,local:true}; 
    } 
  }
  
  async function apiReact(id,key,delta=1){ 
    try{ 
      const r=await fetch(EP.REACT,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id,slug:SLUG,key,delta})}); 
      if(r.status===404) throw new Error('no-react'); 
      const j=await safeJson(r); 
      if(!j.ok) throw new Error(j.error); 
      return j; 
    }catch{ 
      const k='k_react_'+id+'_'+key, v=Number(localStorage.getItem(k)||0)+Number(delta||1); 
      localStorage.setItem(k,Math.max(0,v)); 
      return {ok:true,local:true}; 
    } 
  }
  
  async function apiUpload(file){ 
    try{ 
      setStatus('<span class="spinner"></span> Mengunggah gambar...');
      const buf=await file.arrayBuffer(); 
      const b64=btoa(String.fromCharCode(...new Uint8Array(buf))); 
      const r=await fetch(EP.UPLOAD,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({filename:file.name,contentType:file.type,dataBase64:b64})}); 
      if(r.status===404) throw new Error('no-upload'); 
      const j=await safeJson(r); 
      if(!j.ok) throw new Error(j.error); 
      return j.url; 
    }catch{ 
      return new Promise(res=>{ 
        const fr=new FileReader(); 
        fr.onload=()=>res(fr.result); 
        fr.readAsDataURL(file); 
      }); 
    } 
  }
  
  async function apiPin(id){
    const r = await fetch(EP.PIN, { method:'POST',
      headers: { 'Content-Type':'application/json', ...adminHeader() },
      body: JSON.stringify({ slug: SLUG, id })
    });
    const j = await r.json();
    if(!r.ok || !j.ok) throw new Error(j.error || 'pin fail');
    PIN_ID = j.pinId ?? id;
    return j;
  }

  async function apiUnpin(){
    const r = await fetch(EP.PIN, { method:'POST',
      headers: { 'Content-Type':'application/json', ...adminHeader() },
      body: JSON.stringify({ slug: SLUG, id: null })
    });
    const j = await r.json();
    if(!r.ok || !j.ok) throw new Error(j.error || 'unpin fail');
    PIN_ID = null; 
    return j;
  }

  async function apiDelete(id){
    const r = await fetch(EP.DEL, {
      method:'POST',
      headers: { 'Content-Type':'application/json', ...adminHeader() },
      body: JSON.stringify({ slug: SLUG, id })
    });
    const j = await r.json().catch(()=>({ok:false,error:'Bad JSON'}));
    if(!r.ok || !j.ok) throw new Error(j.error || 'delete fail');
  }
  
  async function loadEmojis(){ 
    try{ 
      const r=await fetch(EP.EMOJI,{cache:'no-store'}); 
      const j=await r.json(); 
      EMOJI_ITEMS=(j.ok&&Array.isArray(j.items))?j.items:[]; 
      EMOJI_MAP = new Map(EMOJI_ITEMS.map(x=>[x.name,x.url])); 
      E.emojiPicker.innerHTML = EMOJI_ITEMS.length? 
        EMOJI_ITEMS.map(e=>`<button type="button" data-name="${e.name}" title="${e.name}"><img src="${e.url}" alt="${e.name}"></button>`).join('') : 
        '<div style="color:#9aa4bf;padding:6px">Folder <b>emoji/</b> kosong</div>'; 
    }catch{ 
      E.emojiPicker.innerHTML='<div style="color:#f6a;padding:6px">Gagal ambil emoji-list</div>'; 
    } 
  }

  /* ====== PATCH: apiGet dengan limit besar & safe JSON ====== */
  async function apiGet(){
    const url = EP.GET(SLUG) + (EP.GET(SLUG).includes('?') ? '&' : '?') + 'limit=500';
    const r = await fetch(url, { cache:'no-store' });
    const ct = r.headers.get('content-type') || '';
    if (!ct.includes('application/json')) {
      // fallback: jangan hancurkan state
      throw new Error('Bukan JSON dari server');
    }
    const j = await r.json();
    if(!j.ok) throw new Error(j.error || 'Gagal memuat');
    const items = (j.items||[]).map(it=>({
      ...it,
      parentId: it.parentId ?? null,
      likes: it.likes ?? 0,
      reactions: it.reactions ?? {},
      role: it.role ?? 'visitor'
    }));
    // simpan cache agar reload aman
    try { sessionStorage.setItem(CACHE_KEY, JSON.stringify({items, pinId: j.pinId||null})); } catch{}
    PIN_ID = j.pinId || null;
    return items;
  }

  /* ====== RENDER ====== */
  function buildTree(items){
    const byId=new Map(items.map(x=>[x.id,x])); 
    items.forEach(x=>{x.children=[]; x.parentName=null;});
    const root=[];
    for(const it of items){ 
      if(it.parentId && byId.has(it.parentId)){ 
        it.parentName = byId.get(it.parentId).name || null; 
        byId.get(it.parentId).children.push(it); 
      } else root.push(it); 
    }
    
    const sortNew=(a,b)=>String(b.createdAt||'').localeCompare(String(a.createdAt||'')); 
    const sortOld=(a,b)=>String(a.createdAt||'').localeCompare(String(b.createdAt||'')); 
    const sortTop=(a,b)=>score(b)-score(a);
    
    const sort = currentSort==='new'?sortNew:currentSort==='old'?sortOld:sortTop;
    const w=arr=>{ arr.sort(sort); arr.forEach(x=>w(x.children)); }; 
    w(root); 
    return root;
  }
  
  function likeLocal(it){ 
    const s=Number(it.likes||0), l=Number(localStorage.getItem('k_like_'+it.id)||0); 
    const t=s+l; 
    return t?` ${t}`:''; 
  }
  
  function reactLocal(it,key){ 
    const s=Number((it.reactions||{})[key]||0), l=Number(localStorage.getItem('k_react_'+it.id+'_'+key)||0); 
    const t=s+l; 
    return t?` ${t}`:''; 
  }
  
  const badge = role=>`<span class="badge ${role==='admin'?'admin':''}">${role==='admin'?'katheryne':'visitor'}</span>`;
  
  function renderMessage(text){
    let s = esc(text || '');
    s = s.replace(/\[\[emoji:([\w.\-]+)\]\]/g,(m,name)=>{
      const url = EMOJI_MAP.get(name);
      return url ? `<img src="${url}" alt="emoji" class="emojiimg">` : m;
    });
    return s;
  }
  
  function adminButtons(it){
    if(!isAdmin()) return '';
    const pinned = String(PIN_ID||'') === String(it.id);
    return `<span class="admin-actions">
      <span class="action" data-act="${pinned?'unpin':'pin'}" data-id="${it.id}">${pinned?'üìå Unpin':'üìå Pin'}</span>
      <span class="action" data-act="delete" data-id="${it.id}">üóëÔ∏è Hapus</span>
    </span>`;
  }
  
  function itemHTML(it){
    const itemScore = score(it);
    const isPopular = currentSort === 'top' && itemScore > 0;
    const img = it.imageUrl?`<div class="imgwrap"><img src="${esc(it.imageUrl)}" alt=""></div>`:'';
    const replyTo = it.parentName ? `<span class="replyto">balas ‚Üí @${esc(it.parentName)}</span>` : '';
    const reacts = COMMENT_REACTIONS.map(r=>`<span class="reaction" data-act="react" data-id="${it.id}" data-key="${r.key}"><img src="${r.icon}" alt=""> ${esc(r.label)}<b>${reactLocal(it,r.key)}</b></span>`).join('');

    // Jika ada anak, sembunyikan default dan tampilkan tombol lihat balasan
    const hasChildren = it.children?.length > 0;
    const childHTML = hasChildren
      ? `<div class="child-toggle" data-id="${it.id}">
           <button type="button" class="toggle-replies" data-act="toggle" data-id="${it.id}">
             üí¨ Lihat ${it.children.length} balasan
           </button>
         </div>
         <div class="children hidden" id="children-${it.id}">
           ${it.children.map(itemHTML).join('')}
         </div>`
      : '';

    return `<div class="item ${isPopular ? 'popular' : ''}" id="item-${it.id}">
      ${isPopular ? `<div class="popular-badge">üî• Populer</div>` : ''}
      ${currentSort === 'top' ? `<div class="score-display">Score: ${itemScore}</div>` : ''}
      <div class="head">
        <span class="name">${esc(it.name)}</span>${badge(it.role)}
        <span class="time">${esc(time(it.createdAt))}</span>
      </div>
      ${replyTo}
      <div class="body">${renderMessage(it.message)}</div>
      ${img}
      <div class="actions">
        <span class="action" data-act="like" data-id="${it.id}">üëç<b>${likeLocal(it)}</b></span>
        <span class="action" data-act="reply" data-id="${it.id}">‚Ü©Ô∏è Reply</span>
        ${adminButtons(it)}
      </div>
      <div class="reactions">${reacts}</div>
      <div class="replybox row" id="replybox-${it.id}" style="display:none">
        <input id="r-name-${it.id}" placeholder="Nama" maxlength="60">
        <textarea id="r-msg-${it.id}" placeholder="Balas @${esc(it.name)}‚Ä¶" maxlength="2000"></textarea>
        <div class="grid2">
          <input id="r-img-${it.id}" placeholder="URL gambar (opsional)">
          <button type="button" class="alt" data-act="pick-child" data-id="${it.id}">Upload‚Ä¶</button>
        </div>
        <button type="button" data-act="send-reply" data-id="${it.id}">Kirim Balasan</button>
      </div>
      ${childHTML}
    </div>`;
  }
  
  function render(){
    const tree=buildTree([...data]);
    E.count.textContent=data.length;
    
    // Update sort header
    if (currentSort === 'top' && data.length > 0) {
      E.sortHeader.style.display = 'flex';
      E.sortHeader.className = 'sort-header popular';
      E.sortHeader.innerHTML = 'üî• Menampilkan komentar terpopuler berdasarkan like dan reaksi';
    } else if (currentSort === 'new' && data.length > 0) {
      E.sortHeader.style.display = 'flex';
      E.sortHeader.className = 'sort-header new';
      E.sortHeader.innerHTML = 'üïê Menampilkan komentar terbaru';
    } else if (currentSort === 'old' && data.length > 0) {
      E.sortHeader.style.display = 'flex';
      E.sortHeader.className = 'sort-header old';
      E.sortHeader.innerHTML = 'üìÖ Menampilkan komentar terlama';
    } else {
      E.sortHeader.style.display = 'none';
    }
    
    // pinned section (FIX: render sebagai tree agar children ikut)
    if (PIN_ID) {
      const pin = data.find(x => String(x.id) === String(PIN_ID));
      if (pin) {
        const treePin = buildTree([pin]);           // <‚Äî ini kuncinya
        E.pinnedWrap.style.display = 'block';
        E.pinnedBox.innerHTML = treePin.map(itemHTML).join('');
      } else {
        E.pinnedWrap.style.display = 'none';
        E.pinnedBox.innerHTML = '';
      }
    } else {
      E.pinnedWrap.style.display = 'none';
      E.pinnedBox.innerHTML = '';
    }
    
    // normal list (exclude pinned root from top level, replies tetap)
    const roots = tree.filter(x=>String(x.id)!==String(PIN_ID));
    
    if (roots.length === 0 && data.length === 0) {
      E.list.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">üí¨</div>
          <div class="empty-state-text">Belum ada komentar</div>
          <div class="empty-state-subtext">Jadilah yang pertama berkomentar!</div>
        </div>
      `;
    } else {
      E.list.innerHTML = roots.length?roots.map(itemHTML).join(''):'';
    }
  }

  /* ====== PATCH: loadAll pakai cache bila fetch gagal ====== */
  async function loadAll(){
    try{
      setStatus('<span class="spinner"></span> Memuat komentar...');
      const items = await apiGet();
      data = items;
      setStatus('');
      render();
    }catch(e){
      // gunakan cache agar UI tidak kosong
      try{
        const c = JSON.parse(sessionStorage.getItem(CACHE_KEY) || '{}');
        if (Array.isArray(c.items) && c.items.length) {
          PIN_ID = c.pinId || null;
          data = c.items;
          render();
          setStatus('‚ö†Ô∏è Mode offline (pakai cache)','warn');
          
          // Tambahkan indikator offline
          const indicator = document.createElement('div');
          indicator.className = 'offline-indicator';
          indicator.textContent = 'üì° Mode Offline';
          document.body.appendChild(indicator);
          setTimeout(() => indicator.remove(), 3000);
          
          return;
        }
      }catch{}
      setStatus('‚ùå '+(e.message||e),'err');
    }
  }

  /* ====== PATCH: setelah submit ‚Äì jangan replace dengan hasil kosong ====== */
  async function submit(parentId=null, file=null){
    const role=isAdmin()?'admin':'visitor';
    const name=(parentId?($('#r-name-'+parentId)||{}).value:E.name.value)||'';
    const message=(parentId?($('#r-msg-'+parentId)||{}).value:E.msg.value)||'';
    let imageUrl=(parentId?($('#r-img-'+parentId)||{}).value:E.imageUrlInput.value)||'';
    
    if(!name.trim() || !message.trim()){ 
      setStatus('Nama & komentar wajib.','err'); 
      return; 
    }
    
    if(file){ 
      imageUrl = await apiUpload(file); 
    }
    
    try{
      setStatus('<span class="spinner"></span> Mengirim...');
      const item = await apiPost({ 
        slug:SLUG, 
        name:name.trim(), 
        message:message.trim(), 
        imageUrl:imageUrl.trim()||null, 
        parentId:parentId||null, 
        role 
      });

      // Optimistic add
      const parentName = parentId ? (data.find(x=>x.id===parentId)?.name || null) : null;
      data.push({ ...item, likes:0, reactions:{}, parentName });
      render();

      if(!parentId){ 
        E.msg.value=''; 
        E.imageUrlInput.value=''; 
        E.fileInput.value=''; 
      }
      
      setStatus('‚úÖ Terkirim','ok');
      localStorage.setItem('kathy_comment_name', name.trim());

      // Sync ‚Üí MERGE, bukan replace. Abaikan jika kosong/error.
      apiGet().then(items=>{
        if (Array.isArray(items) && items.length) {
          data = mergeById(data, items);
          render();
        } // kalau kosong, biarkan data existing
      }).catch(()=>{ /* keep optimistic state */ });

      setTimeout(()=>setStatus(''),2000);
    }catch(e){ 
      console.error('Submit error:', e);
    }
  }

  /* ====== INIT & EVENTS ====== */
  const savedName = localStorage.getItem('kathy_comment_name') || '';
  E.name.value = savedName;
  loadAll(); 
  loadEmojis();

  // emoji picker
  function insertAtCursor(el, text){
    const start = el.selectionStart ?? el.value.length;
    const end   = el.selectionEnd ?? el.value.length;
    el.value = el.value.slice(0,start) + text + el.value.slice(end);
    el.focus(); 
    el.selectionStart = el.selectionEnd = start + text.length;
  }
  
  E.emojiBtn.addEventListener('click',()=>{ 
    E.emojiPicker.style.display = (E.emojiPicker.style.display==='grid'?'none':'grid'); 
  });
  
  E.emojiPicker.addEventListener('click', e=>{
    const btn = e.target.closest('button'); 
    if(!btn) return;
    const name = btn.getAttribute('data-name');
    insertAtCursor(activeTextArea, ` [[emoji:${name}]] `);
  });

  // tools
  E.imageUrlBtn.addEventListener('click',()=>{ 
    E.imageUrlInput.style.display = E.imageUrlInput.style.display==='none'?'inline-block':'none'; 
  });
  
  E.uploadBtn.addEventListener('click',()=>E.fileInput.click());
  
  E.fileInput.addEventListener('change',()=>{ 
    if (E.fileInput.files[0]) {
      setStatus('üì∑ Gambar siap.','ok'); 
    }
  });

  // admin toggle
  E.adminBtn.addEventListener('click', async ()=>{
    const key = prompt('Masukkan ADMIN_KEY');
    if (key === null) return;
    await verifyAdmin(key.trim());
  });

  // admin logout
  E.adminLogoutBtn.addEventListener('click', ()=>{
    localStorage.removeItem('kathy_admin_key');
    ADMIN_OK = false;
    E.badgeLabel.textContent = 'visitor';
    E.adminLogoutBtn.style.display = 'none';
    setStatus('üö™ Keluar dari mode admin','ok');
    render(); // sembunyikan tombol pin/hapus
  });

  // submit & reload
  E.send.addEventListener('click',e=>{ 
    e.preventDefault(); 
    activeTextArea = E.msg; 
    submit(null, E.fileInput.files[0]||null); 
  });
  
  E.reload.addEventListener('click',e=>{ 
    e.preventDefault(); 
    loadAll(); 
  });
  
  E.msg.addEventListener('keydown',e=>{ 
    if(e.key==='Enter' && !e.shiftKey){ 
      e.preventDefault(); 
      E.send.click(); 
    } 
  });

  // sort buttons
  document.querySelectorAll('.sort-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentSort = btn.dataset.sort;
      
      // Add class to body for styling
      document.body.className = currentSort === 'top' ? 'sort-popular' : '';
      
      render();
    });
  });

  // event handler delegation
  const handlerDelegation = async e=>{
    const t=e.target.closest('[data-act]'); 
    if(!t) return;
    const act=t.dataset.act, id=t.dataset.id, key=t.dataset.key;
    
    if(act==='reply'){
      const box=$('#replybox-'+id);
      box.style.display = box.style.display==='none'?'block':'none';
      const ta=$('#r-msg-'+id); 
      if(ta){ 
        activeTextArea=ta; 
        ta.focus(); 
      }
    } else if(act==='pick-child'){
      const inp=document.createElement('input'); 
      inp.type='file'; 
      inp.accept='image/*';
      inp.onchange=()=>{ 
        const box=t.closest('.replybox'); 
        box._file = inp.files?.[0]||null; 
        setStatus('üì∑ Gambar balasan siap.','ok'); 
      };
      inp.click();
    } else if(act==='send-reply'){
      const box=$('#replybox-'+id); 
      await submit(id, box?._file||null); 
      if(box){ 
        box._file=null; 
        box.style.display='none'; 
      }
      activeTextArea = E.msg;
    } else if(act==='like'){
      const b=t.querySelector('b'); 
      b.textContent=' '+(Number((b.textContent||'').trim())+1 || 1);
      try{ 
        await apiLike(id,+1); 
      }catch{
        console.error('Like error');
      }
    } else if(act==='react'){
      const b=t.querySelector('b'); 
      b.textContent=' '+(Number((b.textContent||'').trim())+1 || 1);
      try{ 
        await apiReact(id,key,+1); 
      }catch{
        console.error('React error');
      }
    } else if(act==='pin'){
      try{
        await apiPin(id);
        // sinkron dari server, jangan hanya set lokal
        const items = await apiGet();
        data = items;
        render();
        setStatus('üìå Dipin','ok');
      }catch(e){
        console.error('Pin error:', e);
      }
    } else if(act==='unpin'){
      try{
        await apiUnpin();
        const items = await apiGet();
        data = items;
        render();
        setStatus('‚úÖ Unpin','ok');
      }catch(e){
        console.error('Unpin error:', e);
      }
    } else if(act==='delete'){
      if(!confirm('Hapus komentar ini (termasuk balasannya)?')) return;
      try{
        await apiDelete(id);
        // jika yang dihapus sedang dipin ‚Üí kosongkan pin
        if (String(PIN_ID||'') === String(id)) PIN_ID = null;
        // buang item & semua anaknya dari memori
        data = data.filter(x => String(x.id)!==String(id) && String(x.parentId)!==String(id));
        render();
        setStatus('üóëÔ∏è Dihapus','ok');
      } catch(e){
        setStatus('‚ùå '+(e.message||e),'err');
      }
    } else if(act==='toggle'){
      const id = t.dataset.id;
      const box = document.getElementById(`children-${id}`);
      if(!box) return;
      const btn = t;
      const isHidden = box.classList.toggle('hidden');
      btn.textContent = isHidden
        ? `üí¨ Lihat ${box.children.length} balasan`
        : 'üîΩ Sembunyikan balasan';
    }
  };

  // attach event delegation to both list and pinnedBox
  ['list','pinnedBox'].forEach(idEl=>{
    document.getElementById(idEl).addEventListener('click', handlerDelegation);
  });

  // Close emoji picker when clicking outside
  document.addEventListener('click', (e) => {
    if (!E.emojiBtn.contains(e.target) && !E.emojiPicker.contains(e.target)) {
      E.emojiPicker.style.display = 'none';
    }
  });

  // Auto-sync every 30 seconds
  setInterval(() => {
    if (document.visibilityState === 'visible') {
      apiGet().then(items => {
        if (Array.isArray(items) && items.length) {
          data = mergeById(data, items);
          render();
        }
      }).catch(() => {});
    }
  }, 30000);
})();
</script>
</body>
</html>
