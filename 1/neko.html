<!DOCTYPE html>
<html lang="id">      
<head>      
  <meta charset="UTF-8" />      
  <meta name="viewport" content="width=device-width, initial-scale=1" />      
  <title>Neko UI - Premium Content Browser</title>      
  <meta name="description" content="Premium content browser dengan UI modern dan smooth" />      
  <link rel="preconnect" href="https://fonts.googleapis.com"/>      
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>      
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&family=Sora:wght@400;500;600&display=swap" rel="stylesheet"/>      
  <script src="https://cdn.tailwindcss.com"></script>      
  <style>      
    :root {
      --primary: #00d4ff;
      --primary-dark: #0099cc;
      --secondary: #8b5cf6;
      --background: #0a0e27;
      --surface: #151b3f;
      --surface-light: #1f2849;
      --text-primary: #f5f7fa;
      --text-secondary: #a1a8c1;
      --glass: rgba(255,255,255,.06);
      --glass-light: rgba(255,255,255,.10);
      --glass-heavy: rgba(255,255,255,.14);
    }

    * {
      font-family: 'Sora', system-ui, -apple-system, sans-serif;
    }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    body {
      background: linear-gradient(135deg, #0a0e27 0%, #141829 50%, #0a0e27 100%);
      color: var(--text-primary);
      overflow-x: hidden;
    }

    /* Glass morphism effect */
    .glass {
      background: var(--glass);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, .08);
      transition: all 0.3s ease;
    }

    .glass:hover {
      background: var(--glass-light);
      border-color: rgba(255, 255, 255, .12);
    }

    .glass-heavy {
      background: var(--glass-heavy);
      backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, .12);
    }

    /* Card and hover effects */
    .card {
      transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      border-radius: 16px;
      overflow: hidden;
    }

    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px rgba(0, 212, 255, 0.15);
    }

    /* Smooth scrollbar */
    .scrollbar::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    .scrollbar::-webkit-scrollbar-track {
      background: transparent;
    }

    .scrollbar::-webkit-scrollbar-thumb {
      background: rgba(0, 212, 255, 0.3);
      border-radius: 999px;
      transition: background 0.3s;
    }

    .scrollbar::-webkit-scrollbar-thumb:hover {
      background: rgba(0, 212, 255, 0.5);
    }

    /* Skeleton loading */
    .skeleton {
      background: linear-gradient(90deg, rgba(255,255,255,.05) 25%, rgba(255,255,255,.10) 50%, rgba(255,255,255,.05) 75%);
      background-size: 200% 100%;
      animation: shimmer 2s infinite;
      border-radius: 12px;
    }

    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    /* Line clamp */
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    /* Safe iframe */
    .safe-iframe {
      width: 100%;
      height: 100%;
      border: 0;
      background: #000;
      border-radius: 12px;
    }

    .guard {
      position: absolute;
      inset: 0;
      pointer-events: none;
      border-radius: 12px;
      transition: background 0.3s;
    }

    .guard.active {
      pointer-events: auto;
      background: rgba(10, 14, 39, 0.7);
    }

    /* Router links */
    a.router {
      color: inherit;
      text-decoration: none;
      transition: color 0.3s;
    }

    a.router:hover {
      color: var(--primary);
    }

    /* Button styles */
    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: var(--background);
      font-weight: 600;
      border: none;
      padding: 10px 20px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 12px rgba(0, 212, 255, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 212, 255, 0.4);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .btn-secondary {
      background: var(--glass);
      color: var(--text-primary);
      border: 1px solid rgba(0, 212, 255, 0.3);
      font-weight: 500;
      padding: 10px 16px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-secondary:hover {
      background: var(--glass-light);
      border-color: var(--primary);
      color: var(--primary);
    }

    /* Header */
    .header-sticky {
      position: sticky;
      top: 0;
      z-index: 40;
      border-bottom: 1px solid rgba(0, 212, 255, 0.1);
      background: linear-gradient(180deg, var(--surface) 0%, rgba(21, 27, 63, 0.8) 100%);
      backdrop-filter: blur(12px);
    }

    /* Badge/Chip styles */
    .chip {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 8px;
      border: 1px solid rgba(0, 212, 255, 0.3);
      background: var(--glass);
      cursor: pointer;
      transition: all 0.3s;
      font-size: 13px;
      font-weight: 500;
    }

    .chip:hover {
      background: var(--glass-light);
      border-color: var(--primary);
      color: var(--primary);
      transform: translateY(-1px);
    }

    /* Alert */
    .alert {
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid rgba(255, 67, 67, 0.3);
      background: rgba(255, 67, 67, 0.1);
      color: #ff4343;
      font-size: 14px;
      animation: slideInDown 0.3s ease;
    }

    @keyframes slideInDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Pulse animation for loading */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .animate-pulse {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    /* Responsive grid layout dengan portrait poster */
    @media (max-width: 640px) {
      #grid {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 1rem !important;
      }
    }

    @media (min-width: 641px) and (max-width: 1024px) {
      #grid {
        grid-template-columns: repeat(3, 1fr) !important;
        gap: 1.5rem !important;
      }
    }

    @media (min-width: 1025px) {
      #grid {
        grid-template-columns: repeat(5, 1fr) !important;
        gap: 1.5rem !important;
      }
    }

    /* Portrait poster aspect ratio */
    .poster-portrait {
      aspect-ratio: 9/16;
    }
  </style>      
</head>      
<body class="min-h-screen">
  <!-- HEADER -->    
  <header class="header-sticky">      
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center gap-4">      
      <a href="/" class="router flex items-center gap-2 group">      
        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-cyan-400 to-blue-500 flex items-center justify-center font-bold text-white">
          N
        </div>      
        <h1 class="font-bold text-lg group-hover:text-cyan-400 transition">Neko UI</h1>      
      </a>    
      <div class="ml-auto flex items-center gap-3">      
        <button id="searchToggle" class="btn-secondary sm:hidden p-2.5">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path>
          </svg>      
        </button>      
        <button id="btnBrowse" class="btn-secondary">Jelajah</button>      
      </div>    
    </div>    
    <!-- Search bar -->      
    <div id="searchBar" class="hidden sm:block border-t border-white/10 bg-black/30">      
      <div class="max-w-7xl mx-auto px-4 py-4">
        <form id="searchForm" class="flex flex-col sm:flex-row items-stretch gap-3">      
          <input id="q" placeholder="Cari judul…" class="flex-1 glass rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-cyan-400/50 text-white placeholder:text-gray-500"/>      
          <input id="base" placeholder="Base (opsional)" class="flex-1 glass rounded-lg px-4 py-3 focus:outline-none focus-ring-2 focus:ring-cyan-400/50 text-white placeholder:text-gray-500" />      
          <button type="submit" class="btn-primary px-6">Cari</button>      
        </form>      
      </div>
    </div>      
  </header>    

  <!-- MAIN -->    
  <main id="app" class="max-w-7xl mx-auto px-4 py-8"></main>    

  <!-- TEMPLATES -->    
  <template id="homeTpl">      
    <div id="alert" class="hidden mb-6 alert"></div>      
    
    <!-- Controls Section -->
    <section class="mb-8">      
      <div class="glass-heavy rounded-2xl p-6 border border-cyan-400/10">
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-4">
          <div>
            <h2 class="text-2xl sm:text-3xl font-bold mb-1">Telusuri Konten</h2>
            <p class="text-sm text-gray-400">Pilih genre atau jelajahi koleksi terbaru</p>
          </div>
          <button id="toggleGenresBtn" class="btn-secondary whitespace-nowrap">Tampilkan Genre</button>
        </div>
        <div class="w-full mt-4 hidden" id="genreChipsWrap">
          <div id="genreChips" class="flex flex-wrap gap-2"></div>
        </div>
      </div>
    </section>      
    
    <!-- Grid Section -->
    <section>      
      <div id="grid" class="grid gap-4 sm:gap-6"></div>      
      <div id="empty" class="hidden text-center text-gray-400 py-20">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" class="mx-auto mb-4 opacity-50">
          <circle cx="12" cy="12" r="10"></circle><path d="M12 6v6m0 0v0"></path>
        </svg>
        <p class="text-lg">Tidak ada hasil yang ditemukan</p>
      </div>    
      
      <!-- Pagination -->
      <div id="pager" class="mt-10 flex items-center justify-center gap-4 flex-wrap">      
        <button id="prevBtn" class="btn-secondary px-4" disabled>← Sebelumnya</button>      
        <div id="pageInfo" class="text-sm text-gray-400 font-medium min-w-24 text-center"></div>      
        <button id="nextBtn" class="btn-secondary px-4" disabled>Selanjutnya →</button>      
      </div>    
    </section>      
  </template>    

  <!-- Detail Play Template -->    
  <template id="detailPlayTpl">      
    <div class="space-y-6">      
      <button id="backBtn" class="inline-flex items-center gap-2 text-sm text-gray-400 hover:text-cyan-400 transition px-0 bg-none border-none cursor-pointer font-inherit">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
        Kembali
      </button>    
      
      <div class="glass-heavy rounded-2xl border border-cyan-400/10 shadow-xl overflow-hidden">      
        <!-- Header -->      
        <div class="p-6 flex flex-col sm:flex-row items-start sm:items-center gap-4 border-b border-white/10">      
          <div id="dPosterWrap" class="w-20 h-32 sm:w-24 sm:h-40 overflow-hidden rounded-xl bg-gradient-to-br from-cyan-400/20 to-blue-500/20 flex items-center justify-center flex-shrink-0"></div>      
          <div class="min-w-0 flex-1">      
            <h2 id="dTitle" class="font-bold text-2xl sm:text-3xl line-clamp-2 mb-1"></h2>      
            <div id="dMeta" class="text-sm text-gray-400"></div>      
          </div>      
          <div class="flex items-center gap-3">      
            <label class="flex items-center gap-2 text-sm text-gray-400 hover:text-white select-none cursor-pointer transition">      
              <input id="guardToggle" type="checkbox" class="accent-cyan-400 cursor-pointer"> Anti-Klik      
            </label>      
          </div>      
        </div>        
        
        <!-- Content Grid -->        
        <div class="grid lg:grid-cols-[2fr_1fr] gap-0">      
          <!-- Player -->      
          <div class="relative bg-black aspect-video lg:min-h-[500px]">      
            <iframe id="player" class="safe-iframe"      
              sandbox="allow-scripts allow-same-origin allow-forms allow-pointer-lock"      
              allow="autoplay; fullscreen; picture-in-picture; encrypted-media"      
              referrerpolicy="no-referrer" loading="lazy"></iframe>      
            <div id="clickGuard" class="guard"></div>      

            <!-- Player Controls -->
            <div class="absolute bottom-3 left-3 right-3 flex flex-wrap items-center gap-2 z-10">      
              <div id="embedStatus" class="px-3 py-1.5 rounded-lg glass text-xs font-medium"></div>      
              <button id="openExternal" class="btn-primary text-xs px-3 py-1.5">Buka Tab Baru</button>      
              <button id="reloadEmbed" class="btn-secondary text-xs px-3 py-1.5">Reload</button>      
            </div>      
          </div>      

          <!-- Sidebar -->      
          <aside class="p-6 space-y-6 bg-black/40 lg:border-l border-white/10 overflow-y-auto scrollbar max-h-96 lg:max-h-[500px]">      
            <div>      
              <h4 class="font-bold text-sm mb-3 flex items-center gap-2">
                <span class="w-1 h-4 rounded-full bg-gradient-to-b from-cyan-400 to-blue-500"></span>
                Catatan
              </h4>      
              <div id="dNotes" class="text-sm text-gray-400 whitespace-pre-line leading-relaxed">Memuat…</div>      
            </div>      

            <div id="dDetailBox">      
              <h4 class="font-bold text-sm mb-3 flex items-center gap-2">
                <span class="w-1 h-4 rounded-full bg-gradient-to-b from-cyan-400 to-blue-500"></span>
                Detail
              </h4>      
              <div class="text-sm space-y-2">      
                <div><span class="text-gray-500">Producers:</span> <span id="dProducers" class="text-gray-300">—</span></div>      
                <div><span class="text-gray-500">Artist:</span> <span id="dArtist" class="text-gray-300">—</span></div>      
                <div><span class="text-gray-500">Duration:</span> <span id="dDuration" class="text-gray-300">—</span></div>      
                <div id="dSizesLine" class="hidden"><span class="text-gray-500">Sizes:</span> <span id="dSizes" class="text-gray-300"></span></div>      
              </div>      
              <div id="dGenres" class="mt-4 flex flex-wrap gap-2"></div>      
            </div>      

            <div>      
              <h4 class="font-bold text-sm mb-3 flex items-center gap-2">
                <span class="w-1 h-4 rounded-full bg-gradient-to-b from-cyan-400 to-blue-500"></span>
                Stream
              </h4>      
              <div id="dStreams" class="space-y-2"></div>      
            </div>      

            <div>      
              <h4 class="font-bold text-sm mb-3 flex items-center gap-2">
                <span class="w-1 h-4 rounded-full bg-gradient-to-b from-cyan-400 to-blue-500"></span>
                Download
              </h4>      
              <div id="dDownloads" class="space-y-2"></div>      
            </div>      
          </aside>

        </div>      
      </div>    
    </div>      
  </template>    

  <!-- Detail Hentai Template -->    
  <template id="detailHentaiTpl">      
    <div class="space-y-6">      
      <button id="backBtn" class="inline-flex items-center gap-2 text-sm text-gray-400 hover:text-cyan-400 transition px-0 bg-none border-none cursor-pointer font-inherit">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
        Kembali
      </button>    
      
      <div class="glass-heavy rounded-2xl border border-cyan-400/10 overflow-hidden">      
        <!-- Header -->
        <div class="p-6 flex flex-col sm:flex-row items-start sm:items-center gap-4 border-b border-white/10">      
          <div id="hPoster" class="w-20 h-32 sm:w-24 sm:h-40 rounded-xl bg-gradient-to-br from-cyan-400/20 to-blue-500/20 overflow-hidden flex-shrink-0"></div>      
          <div class="min-w-0 flex-1">      
            <h2 id="hTitle" class="font-bold text-2xl sm:text-3xl line-clamp-2 mb-1"></h2>      
            <div id="hMeta" class="text-sm text-gray-400"></div>      
          </div>      
          <div>      
            <span id="hPage" class="text-xs text-gray-500 font-mono"></span>      
          </div>      
        </div>        

        <div class="grid lg:grid-cols-[1fr_1fr] gap-0">      
          <!-- Main Content -->
          <section class="p-6 space-y-6 border-r border-white/10 overflow-y-auto scrollbar max-h-96 lg:max-h-[500px]">      
            <div>      
              <h4 class="font-bold text-sm mb-3 flex items-center gap-2">
                <span class="w-1 h-4 rounded-full bg-gradient-to-b from-cyan-400 to-blue-500"></span>
                Sinopsis
              </h4>      
              <div id="hSynopsis" class="text-sm text-gray-400 whitespace-pre-line leading-relaxed">Memuat…</div>      
            </div>      
            
            <div>      
              <h4 class="font-bold text-sm mb-3 flex items-center gap-2">
                <span class="w-1 h-4 rounded-full bg-gradient-to-b from-cyan-400 to-blue-500"></span>
                Info
              </h4>      
              <div id="hInfo" class="text-sm grid grid-cols-2 gap-2"></div>      
            </div>      

            <div>      
              <h4 class="font-bold text-sm mb-3 flex items-center gap-2">
                <span class="w-1 h-4 rounded-full bg-gradient-to-b from-cyan-400 to-blue-500"></span>
                Genre
              </h4>      
              <div id="hGenres" class="flex flex-wrap gap-2"></div>      
            </div>      
          </section>      

          <!-- Sidebar -->
          <aside class="p-6 space-y-6 bg-black/40 overflow-y-auto scrollbar max-h-96 lg:max-h-[500px]">      
            <div>      
              <h4 class="font-bold text-sm mb-3 flex items-center gap-2">
                <span class="w-1 h-4 rounded-full bg-gradient-to-b from-cyan-400 to-blue-500"></span>
                Episode
              </h4>      
              <div id="hEpisodes" class="space-y-2"></div>      
            </div>      

            <div>      
              <h4 class="font-bold text-sm mb-3 flex items-center gap-2">
                <span class="w-1 h-4 rounded-full bg-gradient-to-b from-cyan-400 to-blue-500"></span>
                Download
              </h4>      
              <div id="hDownloads" class="space-y-2"></div>      
            </div>      
          </aside>

        </div>      
      </div>    
    </div>      
  </template>    

  <script>      
    const API = "/api/neko";      
    const DEFAULT_BASE_UI = "https://nekopoi.care";      
    const $ = (q, el=document)=> el.querySelector(q);
    const $$ = (q, el=document)=> Array.from(el.querySelectorAll(q));
    const esc = s=> String(s||"").replace(/[&<>"']/g,c=>({"&":"&","<":"<",">":">","\"":"\"","'":"'"}[c]));
    const slugify = s=> String(s||"").toLowerCase().trim().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
    const imgSrc = (u)=> `${API}?t=img&url=${encodeURIComponent(u)}`;
    const weserv = (u)=> `https://images.weserv.nl/?url=${encodeURIComponent(u)}`;
    const api = async (t, params={})=>{
      const url = new URL(API, location.origin);
      url.searchParams.set('t', t);
      for(const [k,v] of Object.entries(params)){ if(v!==undefined && v!=="") url.searchParams.set(k,v); }
      const r = await fetch(url, {credentials:'omit', referrerPolicy:'no-referrer'});
      if(!r.ok) throw new Error(`${r.status} ${r.statusText}`);
      return r.json();
    };

    // Router
    const routes = {
      home  : /^\/?$/i,
      detail: /^\/([^/?#]+)$/i,
    };
    function go(path){ history.pushState({}, "", path); render(); }

    window.addEventListener("popstate", render);
    document.addEventListener("click", (e)=>{
      const a = e.target.closest('a.router');
      if(!a || !a.href) return;
      const href = a.getAttribute('href') || '';
      const isRelative = href.startsWith('/');
      const isSameOrigin = a.origin === location.origin;
      if(isSameOrigin || isRelative){
        e.preventDefault();
        history.pushState({}, "", a.pathname + a.search);
        render();
      }
    });

    document.addEventListener("click", (e)=>{
      if(e.target.closest("#backBtn")){
        e.preventDefault();
        history.back();
      }
    });
    
    // Updated card skeleton to use poster-portrait
    function cardSkeleton(n=8){
      const g = $("#grid"); g.innerHTML="";
      for(let i=0;i<n;i++){
        const d=document.createElement("div");
        d.className="card glass rounded-2xl overflow-hidden border border-white/10";
        d.innerHTML = `
          <div class="w-full poster-portrait skeleton"></div>
          <div class="p-4 space-y-2">
            <div class="h-4 w-3/4 skeleton"></div>
            <div class="h-3 w-1/2 skeleton"></div>
            <div class="h-10 w-full skeleton"></div>
          </div>`;
        g.appendChild(d);
      }
      $("#empty").classList.add("hidden");
    }

    // Updated makeCard to use poster-portrait
    function makeCard(item){
      const img = item.image || item.poster || "";
      const wrap = document.createElement("div");
      wrap.className="card glass rounded-2xl overflow-hidden border border-white/10";
      const title = item.title || "Tanpa Judul";
      const slug = slugify(title);
      const playUrl = encodeURIComponent(item.link || item.page || "");
      wrap.innerHTML = `
        <a class="router block" href="/${slug}?u=${playUrl}">
          <div class="w-full poster-portrait bg-gradient-to-br from-cyan-400/10 to-blue-500/10">
            ${ img ? `<img src="${imgSrc(img)}" onerror="this.onerror=null;this.src='${weserv(img)}'" class="w-full h-full object-cover" referrerpolicy="no-referrer" loading="lazy">` : "" }
          </div>
          <div class="p-4">
            <div class="font-semibold line-clamp-2 mb-2 text-sm">${esc(title)}</div>
            ${item.excerpt ? `<div class="text-xs text-gray-400 line-clamp-2 mb-3">${esc(item.excerpt)}</div>` : ""}
            <div class="w-full px-3 py-2.5 rounded-lg bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-400 hover:to-blue-400 text-white font-semibold text-center text-sm transition transform hover:scale-105">Lihat Detail</div>
          </div>
        </a>`;
      return wrap;
    }

    function renderGrid(list, pagination){
      const g = $("#grid"); g.innerHTML="";
      lastPagination = pagination || null;
      if(!list || !list.length){
        $("#empty").classList.remove("hidden");
      } else {
        $("#empty").classList.add("hidden");
        list.forEach(x=> g.appendChild(makeCard(x)));
      }
      const prevBtn = $("#prevBtn"), nextBtn = $("#nextBtn"), pageInfo=$("#pageInfo");
      const hasPrev = !!(pagination && pagination.has_prev);
      const hasNext = !!(pagination && pagination.has_next);
      const cur = pagination?.current || currentMode.page || 1;
      const total = pagination?.total || null;
      if(prevBtn) prevBtn.disabled = !hasPrev;
      if(nextBtn) nextBtn.disabled = !hasNext;
      if(pageInfo) pageInfo.textContent = cur ? `Hal ${cur}${total?` / ${total}`:""}` : "";
    }

    let lastPagination = null;
    let currentMode = { type: "browse", page: 1, base: "" , q: "", g: "" };

    // Updated DOMContentLoaded event listener
    document.addEventListener("DOMContentLoaded", () => {
      const toggleSearchBar=()=> $("#searchBar").classList.toggle("hidden");
      const handleBrowseClick=async ()=>{
        currentMode={type:"browse",page:1,base:$("#base")?.value||DEFAULT_BASE_UI,q:"",g:""};
        cardSkeleton(12);
        const res=await api("browse",{base:currentMode.base,page:currentMode.page});
        renderGrid(res.data,res.pagination);
      };

      $("#searchToggle").addEventListener("click", toggleSearchBar);
      $("#searchForm").addEventListener("submit", async (e)=>{
        e.preventDefault();
        const q=$("#q").value.trim();
        const base=$("#base").value.trim()||DEFAULT_BASE_UI;
        if(!q){
          const alert=$("#alert");
          alert.textContent="Masukkan kata kunci pencarian!";
          alert.classList.remove("hidden");
          setTimeout(()=>alert.classList.add("hidden"),3000);
          return;
        }
        currentMode={type:"search",page:1,base,q,g:""};
        cardSkeleton(12);
        try{
          const res=await api("search",{q,base,page:currentMode.page});
          renderGrid(res.data,res.pagination);
        }catch(e){
          $("#alert").textContent=e.message;
          $("#alert").classList.remove("hidden");
        }
      });
      $("#btnBrowse").addEventListener("click", handleBrowseClick);

      // Moved click listener inside DOMContentLoaded
      document.addEventListener("click", (e)=>{
        if(e.target.closest("#backBtn")){
          e.preventDefault();
          history.back();
        }
      });

      render();
    });

    async function render(){
      const app = $("#app");
      let path = location.pathname;
      if(routes.home.test(path)){
        app.innerHTML = $("#homeTpl").innerHTML;
        bindHome();
        const baseInput = $("#base");
        if(baseInput) baseInput.value = currentMode.base || DEFAULT_BASE_UI;
      } else if(routes.detail.test(path)){
        const match = path.match(routes.detail);
        const slug = match[1];
        const u = new URLSearchParams(location.search).get("u");
        app.innerHTML = $("#detailPlayTpl").innerHTML;
        await bindDetail(slug,u);
      }
    }

    function bindHome(){
      const tg = $("#toggleGenresBtn");
      const gw = $("#genreChipsWrap");
      tg?.addEventListener("click", ()=> gw.classList.toggle("hidden"));
      const pb=$("#prevBtn"),nb=$("#nextBtn");
      pb?.addEventListener("click", async ()=>{
        if(currentMode.page>1){
          currentMode.page--;
          cardSkeleton(12);
          const res=await api(currentMode.type==="search"?"search":"browse", currentMode);
          renderGrid(res.data,res.pagination);
        }
      });
      nb?.addEventListener("click", async ()=>{
        currentMode.page++;
        cardSkeleton(12);
        const res=await api(currentMode.type==="search"?"search":"browse", currentMode);
        renderGrid(res.data,res.pagination);
      });
    }

    async function bindDetail(slug,url){
      if(!url) return;
      const decUrl=decodeURIComponent(url);
      try{
        const data=await api("detail",{u:decUrl});
        const iplay=data.type==="video";
        if(iplay){
          $("#dTitle").textContent=data.title||"";
          $("#dMeta").innerHTML=data.meta?`<span>${esc(data.meta)}</span>`:"";
          if(data.poster){
            $("#dPosterWrap").innerHTML=`<img src="${imgSrc(data.poster)}" class="w-full h-full object-cover" />`;
          }
          $("#dNotes").textContent=data.notes||"";
          $("#dProducers").textContent=data.producers||"—";
          $("#dArtist").textContent=data.artist||"—";
          $("#dDuration").textContent=data.duration||"—";
          if(data.sizes){
            $("#dSizesLine").classList.remove("hidden");
            $("#dSizes").textContent=data.sizes;
          }
          if(data.genres && data.genres.length){
            $("#dGenres").innerHTML=data.genres.map(g=>`<span class="chip">${esc(g)}</span>`).join("");
          }
          if(data.streams && data.streams.length){
            $("#dStreams").innerHTML=data.streams.map(s=>`<a href="${esc(s.url)}" target="_blank" class="block px-3 py-2 rounded-lg glass hover:bg-glass-light text-cyan-400 text-sm font-medium">${esc(s.name)}</a>`).join("");
          }
          if(data.downloads && data.downloads.length){
            $("#dDownloads").innerHTML=data.downloads.map(d=>`<a href="${esc(d.url)}" target="_blank" class="block px-3 py-2 rounded-lg glass hover:bg-glass-light text-cyan-400 text-sm font-medium">${esc(d.name)}</a>`).join("");
          }
          $("#player").src=data.embed||"";
          $("#embedStatus").textContent=data.embed?"✓ Embed":"Belum ada embed";
          $("#openExternal").addEventListener("click", ()=> window.open(decUrl,"_blank"));
          $("#reloadEmbed").addEventListener("click", ()=> $("#player").src=data.embed||"");
          const gt=$("#guardToggle");
          gt?.addEventListener("change", ()=> $("#clickGuard").classList.toggle("active",gt.checked));
        } else {
          $("#hTitle").textContent=data.title||"";
          $("#hMeta").innerHTML=data.meta?`<span>${esc(data.meta)}</span>`:"";
          if(data.poster){
            $("#hPoster").innerHTML=`<img src="${imgSrc(data.poster)}" class="w-full h-full object-cover" />`;
          }
          $("#hPage").textContent=`${data.current_page||1}/${data.total_pages||1}`;
          $("#hSynopsis").textContent=data.synopsis||"";
          if(data.info){
            const infoHtml=Object.entries(data.info).map(([k,v])=>`<div><span class="text-gray-500">${esc(k)}:</span> <span class="text-gray-300">${esc(v)}</span></div>`).join("");
            $("#hInfo").innerHTML=infoHtml;
          }
          if(data.genres && data.genres.length){
            $("#hGenres").innerHTML=data.genres.map(g=>`<span class="chip">${esc(g)}</span>`).join("");
          }
          if(data.episodes && data.episodes.length){
            $("#hEpisodes").innerHTML=data.episodes.map((ep,i)=>`<a href="/${slugify(data.title)}?u=${encodeURIComponent(ep.link)}" class="router block px-3 py-2 rounded-lg glass hover:bg-glass-light text-cyan-400 text-sm font-medium">${esc(ep.title||`Episode ${i+1}`)}</a>`).join("");
          }
          if(data.downloads && data.downloads.length){
            $("#hDownloads").innerHTML=data.downloads.map(d=>`<a href="${esc(d.url)}" target="_blank" class="block px-3 py-2 rounded-lg glass hover:bg-glass-light text-cyan-400 text-sm font-medium">${esc(d.name)}</a>`).join("");
          }
        }
      }catch(e){
        const alert=document.createElement("div");
        alert.className="alert";
        alert.textContent="Error loading detail: "+e.message;
        $("#app").insertBefore(alert,$("#app").firstChild);
      }
    }
  </script>      
</body>

</html>
